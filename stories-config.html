<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stories Configurator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0a0a0b;
  --surface: #141416;
  --surface-2: #1c1c1f;
  --surface-3: #242428;
  --border: #2a2a2f;
  --border-focus: #4a4a55;
  --text: #e8e8ec;
  --text-secondary: #8b8b96;
  --text-muted: #5a5a65;
  --accent: #f97316;
  --accent-hover: #fb923c;
  --accent-muted: rgba(249,115,22,0.12);
  --danger: #ef4444;
  --danger-muted: rgba(239,68,68,0.12);
  --success: #22c55e;
  --success-muted: rgba(34,197,94,0.12);
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 14px;
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

html { font-size: 14px; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  overflow: hidden;
  height: 100vh;
}

.app { display: flex; height: 100vh; }

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
.sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
}
.sidebar-header h1 {
  font-size: 16px;
  font-weight: 600;
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar-header h1 .dot {
  width: 8px; height: 8px;
  background: var(--accent);
  border-radius: 50%;
  display: inline-block;
}
.sidebar-header p {
  color: var(--text-secondary);
  font-size: 12px;
  margin-top: 4px;
}
.sidebar-section {
  padding: 16px 12px 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.sidebar-section span {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}
.story-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 8px 8px;
}
.story-list::-webkit-scrollbar { width: 4px; }
.story-list::-webkit-scrollbar-track { background: transparent; }
.story-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.story-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: background var(--transition);
  position: relative;
  user-select: none;
}
.story-item:hover { background: var(--surface-2); }
.story-item.active { background: var(--accent-muted); }
.story-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 50%;
  transform: translateY(-50%);
  width: 3px; height: 20px;
  background: var(--accent);
  border-radius: 0 3px 3px 0;
}
.story-item-thumb {
  width: 36px; height: 48px;
  border-radius: 5px;
  object-fit: cover;
  background: var(--surface-3);
  flex-shrink: 0;
}
.story-item-info { flex: 1; min-width: 0; }
.story-item-title {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.story-item-meta {
  font-size: 11px;
  color: var(--text-muted);
}
.story-item-drag {
  color: var(--text-muted);
  cursor: grab;
  font-size: 14px;
  padding: 4px;
  opacity: 0;
  transition: opacity var(--transition);
}
.story-item:hover .story-item-drag { opacity: 1; }

.sidebar-actions {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 14px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary { background: var(--surface-3); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--border); }
.btn-danger { background: var(--danger-muted); color: var(--danger); }
.btn-danger:hover { background: rgba(239,68,68,0.2); }
.btn-ghost { background: transparent; color: var(--text-secondary); }
.btn-ghost:hover { color: var(--text); background: var(--surface-2); }
.btn-sm { padding: 5px 10px; font-size: 11px; }
.btn-full { width: 100%; }
.btn svg { width: 14px; height: 14px; }

/* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
.topbar {
  height: 56px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 16px;
  background: var(--surface);
}
.topbar-tabs {
  display: flex;
  gap: 2px;
  background: var(--surface-2);
  border-radius: var(--radius-sm);
  padding: 3px;
}
.topbar-tab {
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 4px;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all var(--transition);
  border: none;
  background: none;
  font-family: var(--font);
}
.topbar-tab.active {
  background: var(--surface);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.topbar-tab:hover:not(.active) { color: var(--text); }
.topbar-spacer { flex: 1; }

/* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}
.content::-webkit-scrollbar { width: 6px; }
.content::-webkit-scrollbar-track { background: transparent; }
.content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 6px; }

/* ‚îÄ‚îÄ Panel ‚îÄ‚îÄ */
.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  margin-bottom: 20px;
}
.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}
.panel-title { font-size: 14px; font-weight: 600; letter-spacing: -0.01em; }
.panel-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
.form-row { display: flex; gap: 16px; margin-bottom: 16px; }
.form-row:last-child { margin-bottom: 0; }
.form-group { flex: 1; display: flex; flex-direction: column; gap: 6px; }
.form-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-secondary);
}
.form-input {
  padding: 9px 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font);
  font-size: 13px;
  transition: border-color var(--transition);
  outline: none;
}
.form-input:focus { border-color: var(--accent); }
.form-input::placeholder { color: var(--text-muted); }
.form-input-mono { font-family: var(--mono); font-size: 11px; }
select.form-input {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b8b96'%3E%3Cpath d='M6 8L1.5 3.5h9z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px;
}

/* ‚îÄ‚îÄ Pane cards ‚îÄ‚îÄ */
.pane-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  transition: border-color var(--transition);
}
.pane-card:hover { border-color: var(--border-focus); }
.pane-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}
.pane-card-number {
  width: 24px; height: 24px;
  border-radius: 6px;
  background: var(--accent-muted);
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  flex-shrink: 0;
}
.pane-card-actions { margin-left: auto; display: flex; gap: 4px; }
.pane-card-preview {
  width: 60px; height: 80px;
  border-radius: 6px;
  object-fit: cover;
  background: var(--surface-3);
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ Upload zone ‚îÄ‚îÄ */
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
}
.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--accent);
  background: var(--accent-muted);
}
.upload-zone input { display: none; }
.upload-zone-icon { font-size: 28px; margin-bottom: 8px; color: var(--text-muted); }
.upload-zone-text { font-size: 12px; color: var(--text-secondary); }
.upload-zone-text strong { color: var(--accent); }

/* ‚îÄ‚îÄ GitHub bar ‚îÄ‚îÄ */
.github-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  background: var(--surface-2);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}
.github-bar .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.github-bar .status-dot.connected { background: var(--success); }
.github-bar .status-dot.disconnected { background: var(--danger); }
.github-bar .status-text { font-size: 12px; color: var(--text-secondary); flex: 1; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: var(--radius);
  font-size: 13px;
  font-weight: 500;
  z-index: 9999;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--success-muted); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
.toast.error { background: var(--danger-muted); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
.toast.info { background: var(--accent-muted); color: var(--accent); border: 1px solid rgba(249,115,22,0.3); }

/* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  gap: 12px;
}
.empty-state-icon { font-size: 48px; opacity: 0.3; }
.empty-state-text { font-size: 14px; }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 28px;
  width: 520px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow);
}
.modal-title { font-size: 16px; font-weight: 600; margin-bottom: 20px; }

/* ‚îÄ‚îÄ Code preview ‚îÄ‚îÄ */
.code-preview {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.6;
  color: var(--text-secondary);
  max-height: 400px;
  overflow: auto;
  white-space: pre-wrap;
  word-break: break-all;
}

/* ‚îÄ‚îÄ Badge ‚îÄ‚îÄ */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.badge-video { background: rgba(139,92,246,0.15); color: #a78bfa; }
.badge-image { background: rgba(59,130,246,0.15); color: #60a5fa; }

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.3s ease forwards; }

/* ‚îÄ‚îÄ Import progress ‚îÄ‚îÄ */
.import-progress {
  margin-top: 12px;
  padding: 12px;
  background: var(--surface-2);
  border-radius: var(--radius-sm);
  font-size: 12px;
  color: var(--text-secondary);
}
.import-progress .bar {
  height: 4px;
  background: var(--surface-3);
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}
.import-progress .bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.3s ease;
}
</style>
</head>
<body>

<div class="app" id="app">
  <div class="sidebar">
    <div class="sidebar-header">
      <h1><span class="dot"></span> Stories Config</h1>
      <p>Visual story editor for e-commerce</p>
    </div>

    <div class="sidebar-section">
      <span>Stories</span>
      <button class="btn btn-ghost btn-sm" onclick="addStory()" title="Add story">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add
      </button>
    </div>

    <div class="story-list" id="storyList"></div>

    <div class="sidebar-actions">
      <button class="btn btn-secondary btn-full" onclick="openHeaderEditor()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Edit Header
      </button>
      <button class="btn btn-secondary btn-full" onclick="openGitHubConfig()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22"/></svg>
        GitHub Settings
      </button>
      <button class="btn btn-secondary btn-full" onclick="importFromJSON()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Import JSON
      </button>
      <button class="btn btn-primary btn-full" onclick="exportConfig()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export Config
      </button>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <div class="topbar-tabs">
        <button class="topbar-tab active" data-tab="editor" onclick="switchTab('editor', this)">Editor</button>
        <button class="topbar-tab" data-tab="preview" onclick="switchTab('preview', this)">JSON Preview</button>
      </div>
      <div class="topbar-spacer"></div>
      <span style="font-size:11px;color:var(--text-muted)" id="storyCount"></span>
    </div>

    <div class="content" id="editorContent">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üìñ</div>
        <div class="empty-state-text">Select a story or add a new one to start editing</div>
      </div>
      <div id="storyEditor" style="display:none"></div>
    </div>

    <div class="content" id="previewContent" style="display:none">
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Configuration JSON</div>
            <div class="panel-subtitle">Full config ‚Äî paste into your stories component</div>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="copyJSON()">Copy JSON</button>
        </div>
        <div class="code-preview" id="jsonPreview"></div>
      </div>
    </div>
  </div>
</div>

<!-- Header modal -->
<div class="modal-overlay" id="headerModal">
  <div class="modal">
    <div class="modal-title">Header Settings</div>
    <div class="form-group" style="margin-bottom:20px">
      <label class="form-label">Section Title</label>
      <input class="form-input" id="headerTitle" placeholder="e.g. The Look Of The Games">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeModal('headerModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveHeader()">Save</button>
    </div>
  </div>
</div>

<!-- GitHub modal -->
<div class="modal-overlay" id="githubModal">
  <div class="modal">
    <div class="modal-title">GitHub Upload Settings</div>
    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Connect a GitHub repo to upload images and videos directly from this tool. Requires a <a href="https://github.com/settings/tokens" target="_blank" style="color:var(--accent)">Personal Access Token</a> with <code style="font-family:var(--mono);font-size:11px;background:var(--surface-2);padding:2px 5px;border-radius:3px">repo</code> scope.</p>
    <div class="form-group" style="margin-bottom:16px">
      <label class="form-label">Personal Access Token</label>
      <input class="form-input form-input-mono" id="ghToken" type="password" placeholder="ghp_xxxxxxxxxxxx">
    </div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="form-group">
        <label class="form-label">Owner / Org</label>
        <input class="form-input form-input-mono" id="ghOwner" placeholder="e.g. cdbxyz">
      </div>
      <div class="form-group">
        <label class="form-label">Repository</label>
        <input class="form-input form-input-mono" id="ghRepo" placeholder="e.g. shopthelook">
      </div>
    </div>
    <div class="form-row" style="margin-bottom:20px">
      <div class="form-group">
        <label class="form-label">Branch</label>
        <input class="form-input form-input-mono" id="ghBranch" value="main" placeholder="main">
      </div>
      <div class="form-group">
        <label class="form-label">Upload Path Prefix</label>
        <input class="form-input form-input-mono" id="ghPath" placeholder="e.g. stories/" value="">
      </div>
    </div>
    <div id="ghStatus"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-secondary" onclick="closeModal('githubModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGitHub()">Save &amp; Connect</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let config = { header: 'The Look Of The Games', stories: [] };
let selectedStoryIdx = -1;
let github = { token: '', owner: '', repo: '', branch: 'main', path: '' };

// Load persisted state
try {
  const saved = localStorage.getItem('stories-config');
  if (saved) config = JSON.parse(saved);
  const savedGH = localStorage.getItem('stories-github');
  if (savedGH) github = JSON.parse(savedGH);
} catch(e) {}

function save() {
  try { localStorage.setItem('stories-config', JSON.stringify(config)); } catch(e) {}
  renderSidebar();
  updateCount();
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + type + ' show';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ
function renderSidebar() {
  const list = document.getElementById('storyList');
  list.innerHTML = config.stories.map((s, i) => {
    const thumbEl = s.thumb
      ? '<img class="story-item-thumb" src="' + esc(s.thumb) + '" onerror="this.style.display=\'none\'">'
      : '<div class="story-item-thumb" style="display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:16px">üì∑</div>';
    return '<div class="story-item ' + (i === selectedStoryIdx ? 'active' : '') + '" onclick="selectStory(' + i + ')" draggable="true" data-idx="' + i + '">'
      + thumbEl
      + '<div class="story-item-info">'
      + '<div class="story-item-title">' + (s.title || 'Untitled Story') + '</div>'
      + '<div class="story-item-meta">' + s.slides.length + ' pane' + (s.slides.length !== 1 ? 's' : '') + '</div>'
      + '</div>'
      + '<div class="story-item-drag" title="Drag to reorder">‚†ø</div>'
      + '</div>';
  }).join('');

  // Drag reorder
  list.querySelectorAll('.story-item').forEach(el => {
    el.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', el.dataset.idx);
      el.style.opacity = '0.4';
    });
    el.addEventListener('dragend', () => el.style.opacity = '1');
    el.addEventListener('dragover', e => { e.preventDefault(); el.style.background = 'var(--accent-muted)'; });
    el.addEventListener('dragleave', () => el.style.background = '');
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.style.background = '';
      const from = parseInt(e.dataTransfer.getData('text/plain'));
      const to = parseInt(el.dataset.idx);
      if (from !== to) {
        const [moved] = config.stories.splice(from, 1);
        config.stories.splice(to, 0, moved);
        if (selectedStoryIdx === from) selectedStoryIdx = to;
        else if (from < selectedStoryIdx && to >= selectedStoryIdx) selectedStoryIdx--;
        else if (from > selectedStoryIdx && to <= selectedStoryIdx) selectedStoryIdx++;
        save();
        renderEditor();
      }
    });
  });
}

function updateCount() {
  const total = config.stories.reduce((sum, s) => sum + s.slides.length, 0);
  document.getElementById('storyCount').textContent = config.stories.length + ' stories ¬∑ ' + total + ' panes';
}

// ‚îÄ‚îÄ Story CRUD ‚îÄ‚îÄ
function addStory() {
  config.stories.push({
    id: 'story-' + Date.now(),
    title: '',
    subtitle: '',
    thumb: '',
    avatar: '',
    slides: []
  });
  selectedStoryIdx = config.stories.length - 1;
  save();
  renderEditor();
  toast('New story added', 'success');
}

function deleteStory(idx) {
  if (!confirm('Delete "' + (config.stories[idx].title || 'Untitled') + '" and all its panes?')) return;
  config.stories.splice(idx, 1);
  if (selectedStoryIdx >= config.stories.length) selectedStoryIdx = config.stories.length - 1;
  save();
  renderEditor();
  toast('Story deleted', 'info');
}

function selectStory(idx) {
  selectedStoryIdx = idx;
  renderSidebar();
  renderEditor();
}

// ‚îÄ‚îÄ Editor ‚îÄ‚îÄ
function renderEditor() {
  const empty = document.getElementById('emptyState');
  const editor = document.getElementById('storyEditor');

  if (selectedStoryIdx < 0 || selectedStoryIdx >= config.stories.length) {
    empty.style.display = 'flex';
    editor.style.display = 'none';
    return;
  }

  empty.style.display = 'none';
  editor.style.display = 'block';

  const s = config.stories[selectedStoryIdx];
  const idx = selectedStoryIdx;

  let html = '';

  // Story settings panel
  html += '<div class="panel fade-in">';
  html += '<div class="panel-header"><div>';
  html += '<div class="panel-title">Story Card Settings</div>';
  html += '<div class="panel-subtitle">How this story appears on the homepage rail</div>';
  html += '</div>';
  html += '<button class="btn btn-danger btn-sm" onclick="deleteStory(' + idx + ')">Delete Story</button>';
  html += '</div>';

  html += '<div class="form-row">';
  html += '<div class="form-group"><label class="form-label">Title</label>';
  html += '<input class="form-input" value="' + esc(s.title) + '" onchange="updateStory(\'title\', this.value)" placeholder="e.g. That Viral Olympic Jacket"></div>';
  html += '<div class="form-group"><label class="form-label">Subtitle</label>';
  html += '<input class="form-input" value="' + esc(s.subtitle) + '" onchange="updateStory(\'subtitle\', this.value)" placeholder="e.g. Lookbook"></div>';
  html += '</div>';

  html += '<div class="form-row">';
  html += '<div class="form-group" style="flex:2"><label class="form-label">Card Thumbnail URL</label>';
  html += '<div style="display:flex;gap:8px">';
  html += '<input class="form-input form-input-mono" style="flex:1" value="' + esc(s.thumb) + '" onchange="updateStory(\'thumb\', this.value); updateStory(\'avatar\', this.value)" placeholder="https://...">';
  html += '<button class="btn btn-secondary btn-sm" onclick="uploadForField(\'thumb\')" title="Upload image">üì§ Upload</button>';
  html += '</div></div></div>';

  if (s.thumb) {
    html += '<div style="margin-top:12px"><img src="' + esc(s.thumb) + '" style="width:80px;height:120px;object-fit:cover;border-radius:8px;border:1px solid var(--border)" onerror="this.style.display=\'none\'"></div>';
  }
  html += '</div>';

  // Panes panel
  html += '<div class="panel fade-in" style="animation-delay:0.05s">';
  html += '<div class="panel-header"><div>';
  html += '<div class="panel-title">Panes</div>';
  html += '<div class="panel-subtitle">' + s.slides.length + ' pane' + (s.slides.length !== 1 ? 's' : '') + ' in this story</div>';
  html += '</div>';
  html += '<div style="display:flex;gap:6px">';
  html += '<button class="btn btn-secondary btn-sm" onclick="addPanesBulkURL()">+ URLs</button>';
  html += '<button class="btn btn-primary btn-sm" onclick="addPane()">+ Add Pane</button>';
  html += '</div></div>';

  html += '<div id="paneList">';
  s.slides.forEach((slide, pi) => { html += renderPaneCard(slide, pi); });
  html += '</div>';

  // Bulk upload zone if empty
  if (s.slides.length === 0) {
    html += '<div class="upload-zone" id="bulkUpload" onclick="document.getElementById(\'bulkFileInput\').click()">';
    html += '<input type="file" id="bulkFileInput" multiple accept="image/*,video/mp4" onchange="handleBulkUpload(event)">';
    html += '<div class="upload-zone-icon">üìÅ</div>';
    html += '<div class="upload-zone-text">Drop files here or <strong>click to upload</strong><br>Images and MP4 videos ¬∑ Uploads to GitHub</div>';
    html += '</div>';
  }

  html += '</div>';
  editor.innerHTML = html;

  // Bulk upload drag events
  const bulkZone = document.getElementById('bulkUpload');
  if (bulkZone) {
    bulkZone.addEventListener('dragover', e => { e.preventDefault(); bulkZone.classList.add('dragover'); });
    bulkZone.addEventListener('dragleave', () => bulkZone.classList.remove('dragover'));
    bulkZone.addEventListener('drop', e => {
      e.preventDefault();
      bulkZone.classList.remove('dragover');
      handleBulkFiles(e.dataTransfer.files);
    });
  }
}

function renderPaneCard(slide, idx) {
  const isVideo = slide.type === 'video';
  const previewSrc = isVideo ? '' : (slide.image || '');

  let html = '<div class="pane-card fade-in" style="animation-delay:' + (idx * 0.03) + 's">';

  // Header
  html += '<div class="pane-card-header">';
  html += '<div class="pane-card-number">' + (idx + 1) + '</div>';
  html += '<span class="badge ' + (isVideo ? 'badge-video' : 'badge-image') + '">' + (isVideo ? '‚ñ∂ Video' : 'üñº Image') + '</span>';
  html += '<div class="pane-card-actions">';
  if (idx > 0) html += '<button class="btn btn-ghost btn-sm" onclick="movePane(' + idx + ', -1)" title="Move up">‚Üë</button>';
  if (idx < config.stories[selectedStoryIdx].slides.length - 1) html += '<button class="btn btn-ghost btn-sm" onclick="movePane(' + idx + ', 1)" title="Move down">‚Üì</button>';
  html += '<button class="btn btn-ghost btn-sm" onclick="duplicatePane(' + idx + ')" title="Duplicate">‚ßâ</button>';
  html += '<button class="btn btn-danger btn-sm" onclick="deletePane(' + idx + ')" title="Delete">‚úï</button>';
  html += '</div></div>';

  // Media URL
  html += '<div class="form-row">';
  html += '<div class="form-group" style="flex:2"><label class="form-label">' + (isVideo ? 'Video URL' : 'Image URL') + '</label>';
  html += '<div style="display:flex;gap:8px">';
  html += '<input class="form-input form-input-mono" style="flex:1" value="' + esc(isVideo ? slide.src : slide.image) + '" onchange="updatePane(' + idx + ', \'' + (isVideo ? 'src' : 'image') + '\', this.value)" placeholder="https://...">';
  html += '<button class="btn btn-secondary btn-sm" onclick="uploadForPane(' + idx + ')">üì§</button>';
  html += '</div></div>';
  if (previewSrc) html += '<img class="pane-card-preview" src="' + esc(previewSrc) + '" onerror="this.style.display=\'none\'">';
  html += '</div>';

  // Type + Duration
  html += '<div class="form-row">';
  html += '<div class="form-group"><label class="form-label">Type</label>';
  html += '<select class="form-input" onchange="togglePaneType(' + idx + ', this.value)">';
  html += '<option value="image"' + (!isVideo ? ' selected' : '') + '>Image</option>';
  html += '<option value="video"' + (isVideo ? ' selected' : '') + '>Video</option>';
  html += '</select></div>';
  html += '<div class="form-group"><label class="form-label">Duration (ms)</label>';
  html += '<input class="form-input" type="number" step="1000" value="' + (slide.duration || 5000) + '" onchange="updatePane(' + idx + ', \'duration\', parseInt(this.value))"></div>';
  html += '</div>';

  // Label + Product
  html += '<div class="form-row">';
  html += '<div class="form-group"><label class="form-label">Label</label>';
  html += '<input class="form-input" value="' + esc(slide.label || '') + '" onchange="updatePane(' + idx + ', \'label\', this.value)" placeholder="e.g. The Olympic Collection"></div>';
  html += '<div class="form-group"><label class="form-label">Product Name</label>';
  html += '<input class="form-input" value="' + esc(slide.product || '') + '" onchange="updatePane(' + idx + ', \'product\', this.value)" placeholder="e.g. Full Zip Hoodie"></div>';
  html += '</div>';

  // Price + CTA
  html += '<div class="form-row">';
  html += '<div class="form-group"><label class="form-label">Price</label>';
  html += '<input class="form-input" value="' + esc(slide.price || '') + '" onchange="updatePane(' + idx + ', \'price\', this.value)" placeholder="e.g. ¬£95.00"></div>';
  html += '<div class="form-group"><label class="form-label">CTA Text</label>';
  html += '<input class="form-input" value="' + esc(slide.cta || '') + '" onchange="updatePane(' + idx + ', \'cta\', this.value)" placeholder="e.g. Shop Now"></div>';
  html += '</div>';

  // Link
  html += '<div class="form-group"><label class="form-label">Link URL</label>';
  html += '<input class="form-input form-input-mono" value="' + esc(slide.link || '') + '" onchange="updatePane(' + idx + ', \'link\', this.value)" placeholder="https://shop.olympics.com/..."></div>';

  html += '</div>';
  return html;
}

function esc(str) { return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

// ‚îÄ‚îÄ Story updates ‚îÄ‚îÄ
function updateStory(key, value) {
  if (selectedStoryIdx < 0) return;
  config.stories[selectedStoryIdx][key] = value;
  if (key === 'thumb') config.stories[selectedStoryIdx].avatar = value;
  if (key === 'title') {
    config.stories[selectedStoryIdx].id = value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'story-' + Date.now();
  }
  save();
  if (key === 'thumb') renderEditor();
}

// ‚îÄ‚îÄ Pane CRUD ‚îÄ‚îÄ
function addPane() {
  if (selectedStoryIdx < 0) return;
  config.stories[selectedStoryIdx].slides.push({
    image: '', label: '', product: '', price: '', cta: 'Shop Now', link: '', duration: 5000
  });
  save();
  renderEditor();
  setTimeout(() => { document.getElementById('editorContent').scrollTop = 99999; }, 50);
}

function addPanesBulkURL() {
  const urls = prompt('Paste image/video URLs (one per line):');
  if (!urls) return;
  urls.split('\n').map(u => u.trim()).filter(Boolean).forEach(url => {
    const isVid = /\.mp4/i.test(url);
    const slide = { label: '', product: '', price: '', cta: 'Shop Now', link: '', duration: isVid ? 10000 : 5000 };
    if (isVid) { slide.type = 'video'; slide.src = url; }
    else { slide.image = url; }
    config.stories[selectedStoryIdx].slides.push(slide);
  });
  save();
  renderEditor();
  toast('Panes added from URLs', 'success');
}

function deletePane(idx) {
  config.stories[selectedStoryIdx].slides.splice(idx, 1);
  save();
  renderEditor();
}

function duplicatePane(idx) {
  const copy = JSON.parse(JSON.stringify(config.stories[selectedStoryIdx].slides[idx]));
  config.stories[selectedStoryIdx].slides.splice(idx + 1, 0, copy);
  save();
  renderEditor();
  toast('Pane duplicated', 'success');
}

function movePane(idx, dir) {
  const slides = config.stories[selectedStoryIdx].slides;
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= slides.length) return;
  [slides[idx], slides[newIdx]] = [slides[newIdx], slides[idx]];
  save();
  renderEditor();
}

function updatePane(idx, key, value) {
  config.stories[selectedStoryIdx].slides[idx][key] = value;
  save();
}

function togglePaneType(idx, type) {
  const slide = config.stories[selectedStoryIdx].slides[idx];
  if (type === 'video') {
    slide.type = 'video';
    slide.src = slide.image || '';
    delete slide.image;
    slide.duration = slide.duration || 10000;
  } else {
    delete slide.type;
    slide.image = slide.src || '';
    delete slide.src;
    slide.duration = slide.duration || 5000;
  }
  save();
  renderEditor();
}

// ‚îÄ‚îÄ GitHub Upload ‚îÄ‚îÄ
async function uploadToGitHub(file) {
  if (!github.token || !github.owner || !github.repo) {
    toast('Configure GitHub settings first', 'error');
    openGitHubConfig();
    return null;
  }
  const sanitized = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  const ts = Date.now().toString(36);
  const path = (github.path ? github.path.replace(/\/$/, '') + '/' : '') + ts + '_' + sanitized;

  toast('Uploading ' + sanitized + '...', 'info');

  try {
    const base64 = await fileToBase64(file);
    const resp = await fetch('https://api.github.com/repos/' + github.owner + '/' + github.repo + '/contents/' + path, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + github.token,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({
        message: 'Upload ' + sanitized + ' via Stories Configurator',
        content: base64,
        branch: github.branch
      })
    });
    if (!resp.ok) {
      const err = await resp.json();
      throw new Error(err.message || 'Upload failed');
    }
    const data = await resp.json();
    toast('Uploaded ' + sanitized, 'success');
    return data.content.download_url;
  } catch (e) {
    toast('Upload failed: ' + e.message, 'error');
    return null;
  }
}

function fileToBase64(file) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result.split(',')[1]);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

async function uploadForField(field) {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = async () => {
    const url = await uploadToGitHub(input.files[0]);
    if (url) { updateStory(field, url); renderEditor(); }
  };
  input.click();
}

async function uploadForPane(idx) {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*,video/mp4';
  input.onchange = async () => {
    const file = input.files[0];
    const url = await uploadToGitHub(file);
    if (url) {
      const slide = config.stories[selectedStoryIdx].slides[idx];
      if (file.type.startsWith('video/')) { slide.type = 'video'; slide.src = url; delete slide.image; }
      else { delete slide.type; slide.image = url; delete slide.src; }
      save(); renderEditor();
    }
  };
  input.click();
}

async function handleBulkUpload(e) { handleBulkFiles(e.target.files); }

async function handleBulkFiles(files) {
  if (!files.length) return;
  for (const file of files) {
    const isVid = file.type.startsWith('video/');
    const url = await uploadToGitHub(file);
    if (url) {
      const slide = { label: '', product: '', price: '', cta: 'Shop Now', link: '', duration: isVid ? 10000 : 5000 };
      if (isVid) { slide.type = 'video'; slide.src = url; } else { slide.image = url; }
      config.stories[selectedStoryIdx].slides.push(slide);
    }
  }
  save(); renderEditor();
  toast('Added ' + files.length + ' pane(s)', 'success');
}

// ‚îÄ‚îÄ Header ‚îÄ‚îÄ
function openHeaderEditor() {
  document.getElementById('headerTitle').value = config.header;
  document.getElementById('headerModal').classList.add('open');
}
function saveHeader() {
  config.header = document.getElementById('headerTitle').value;
  save(); closeModal('headerModal');
  toast('Header updated', 'success');
}

// ‚îÄ‚îÄ GitHub Settings ‚îÄ‚îÄ
function openGitHubConfig() {
  document.getElementById('ghToken').value = github.token;
  document.getElementById('ghOwner').value = github.owner;
  document.getElementById('ghRepo').value = github.repo;
  document.getElementById('ghBranch').value = github.branch;
  document.getElementById('ghPath').value = github.path;
  updateGHStatus();
  document.getElementById('githubModal').classList.add('open');
}
function saveGitHub() {
  github.token = document.getElementById('ghToken').value;
  github.owner = document.getElementById('ghOwner').value;
  github.repo = document.getElementById('ghRepo').value;
  github.branch = document.getElementById('ghBranch').value;
  github.path = document.getElementById('ghPath').value;
  try { localStorage.setItem('stories-github', JSON.stringify(github)); } catch(e) {}
  closeModal('githubModal');
  toast('GitHub settings saved', 'success');
}
function updateGHStatus() {
  const el = document.getElementById('ghStatus');
  if (github.token && github.owner && github.repo) {
    el.innerHTML = '<div class="github-bar"><div class="status-dot connected"></div><span class="status-text">Connected to ' + github.owner + '/' + github.repo + '</span></div>';
  } else {
    el.innerHTML = '<div class="github-bar"><div class="status-dot disconnected"></div><span class="status-text">Not connected ‚Äî fill in details above</span></div>';
  }
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function switchTab(tab, btn) {
  document.querySelectorAll('.topbar-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('editorContent').style.display = tab === 'editor' ? '' : 'none';
  document.getElementById('previewContent').style.display = tab === 'preview' ? '' : 'none';
  if (tab === 'preview') renderJSON();
}
function renderJSON() {
  document.getElementById('jsonPreview').textContent = JSON.stringify(config, null, 2);
}
function copyJSON() {
  navigator.clipboard.writeText(JSON.stringify(config, null, 2));
  toast('JSON copied to clipboard', 'success');
}

// ‚îÄ‚îÄ Import ‚îÄ‚îÄ
function importFromJSON() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json,application/json';
  input.onchange = async () => {
    try {
      const text = await input.files[0].text();
      const data = JSON.parse(text);
      if (data.header) config.header = data.header;
      if (Array.isArray(data.stories)) config.stories = data.stories;
      selectedStoryIdx = config.stories.length > 0 ? 0 : -1;
      save(); renderEditor();
      toast('Imported ' + config.stories.length + ' stories', 'success');
    } catch(e) {
      toast('Invalid JSON file', 'error');
    }
  };
  input.click();
}

// ‚îÄ‚îÄ Export ‚îÄ‚îÄ
function exportConfig() {
  const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'stories-config.json'; a.click();
  URL.revokeObjectURL(url);
  toast('Config exported as JSON', 'success');
}

// ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
  if ((e.metaKey || e.ctrlKey) && e.key === 's') { e.preventDefault(); exportConfig(); }
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
renderSidebar();
updateCount();
</script>
</body>
</html>
